{% extends 'support/base.html' %}
{% load static %}

{% block content %}
<div class="container my-4">
  <div class="row">
    <!-- Sidebar: Ticket Info -->
    <div class="col-md-4">
      <div class="card shadow-sm border-0 mb-3">
        <div class="card-body">
          <h6 class="fw-bold text-secondary mb-3">üé´ Ticket Details</h6>
          <p><strong>Subject:</strong> {{ ticket.subject }}</p>
          <p><strong>Customer:</strong> {{ ticket.customer.username }}</p>
          <p><strong>Category:</strong> {{ ticket.category.name|default:"General" }}</p>
          <p><strong>Status:</strong> 
            <span class="badge {% if ticket.status == 'pending' %}bg-warning{% elif ticket.status == 'replied' %}bg-success{% else %}bg-secondary{% endif %}">
              {{ ticket.get_status_display }}
            </span>
          </p>
          <p><strong>Created:</strong> {{ ticket.created_at|date:"M d, Y H:i" }}</p>
        </div>
      </div>
    </div>

    <!-- Chat Section -->
    <div class="col-md-8 d-flex flex-column">
      <div class="card shadow-sm border-0 flex-grow-1 d-flex flex-column">
        <!-- Chat Body -->
        <div class="card-body chat-body flex-grow-1 overflow-auto p-3" 
             style="max-height: 500px; background:#f5f7fa; border-radius: 8px;">
          
          <!-- Initial message -->
          <div class="chat-message left mb-4">
            <div class="bubble customer">
              {{ ticket.message }}
            </div>
            <small class="text-muted d-block mt-1">
              üë§ {{ ticket.customer.username }} ‚Ä¢ {{ ticket.created_at|date:"M d, Y H:i" }}
            </small>
          </div>

          <!-- Replies -->
          {% for reply in replies %}
            <div class="chat-message {% if reply.responder.is_staff %}right{% else %}left{% endif %} mb-4">
              <div class="bubble {% if reply.is_modified %}modified-ai{% elif reply.responder.is_staff %}staff{% else %}customer{% endif %}">
                {{ reply.message }}
                {% if reply.is_ai_generated %}
                  <div class="ai-indicator">ü§ñ AI Generated</div>
                {% elif reply.is_modified %}
                  <div class="modified-indicator">‚úèÔ∏è Modified by Admin</div>
                {% endif %}
              </div>
              <small class="text-muted d-block mt-1 {% if reply.responder.is_staff %}text-end{% endif %}">
                {{ reply.responder.username }} ‚Ä¢ {{ reply.created_at|date:"M d, Y H:i" }}
              </small>

              {% if user.is_staff %}
              <form method="post" action="{% url 'delete_response' reply.id %}" class="mt-1 {% if reply.responder.is_staff %}text-end{% endif %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-danger">üóë Delete</button>
              </form>
              {% endif %}
            </div>
          {% empty %}
            <p class="text-muted">No replies yet.</p>
          {% endfor %}
        </div>

        <!-- Chat Input -->
        <div class="card-footer bg-white border-0">
          <button id="generate-ai-btn" class="btn btn-outline-info w-100 mb-2" data-ticket-id="{{ ticket.id }}">
            ‚ú® Generate AI Response
          </button>
          <form method="post" class="d-flex">
            {% csrf_token %}
            {{ form.message }}
            <button type="submit" class="btn btn-primary ms-2">Send</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chat Bubble Styling -->
<style>
.chat-message {
  display: flex;
  flex-direction: column;
  max-width: 75%;
}
.chat-message.right {
  margin-left: auto;
  align-items: flex-end;
}
.chat-message.left {
  margin-right: auto;
  align-items: flex-start;
}
.bubble {
  padding: 12px 16px;
  border-radius: 16px;
  font-size: 0.95rem;
  line-height: 1.4;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  max-width: 80%; /* Ensure the bubble does not exceed 80% of the container width */
  word-wrap: break-word; /* Allow text to wrap within the bubble */
}
.bubble.customer {
  background: #e9ecef;
  color: #212529;
  border-bottom-left-radius: 4px;
}
.bubble.staff {
  background: #007bff;
  color: #fff;
  border-bottom-right-radius: 4px;
}
.bubble.modified-ai {
  background: #ffc107;
  color: #212529;
  border: 2px solid #fd7e14;
  position: relative;
}

/* Modified AI messages on the right side (admin) */
.chat-message.right .bubble.modified-ai {
  border-bottom-right-radius: 4px;
}


.ai-indicator, .modified-indicator {
  font-size: 0.75rem;
  margin-top: 8px;
  padding: 2px 6px;
  border-radius: 12px;
  display: inline-block;
}

.ai-indicator {
  background: rgba(255, 255, 255, 0.2);
  color: #fff;
}

.modified-indicator {
  background: rgba(253, 126, 20, 0.2);
  color: #fd7e14;
  font-weight: 500;
}
</style>

<!-- JS -->
<script>

document.addEventListener("DOMContentLoaded", function () {

      const alerts = document.querySelectorAll(".alert");
  
  alerts.forEach(alert => {
    setTimeout(() => {
      // Fade out
      alert.style.transition = "opacity 0.5s ease";
      alert.style.opacity = "0";

      // Remove from DOM after fade
      setTimeout(() => alert.remove(), 500);
    }, 3000); // 3 seconds
  });
  // Auto-scroll chat to bottom
  const chatBody = document.querySelector(".chat-body");
  if (chatBody) {
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  // Handle AI response button
  const aiBtn = document.getElementById('generate-ai-btn');
  if (aiBtn) {
    aiBtn.addEventListener('click', function() {
      const ticketId = this.getAttribute('data-ticket-id');
      const button = this;
      button.disabled = true;
      button.textContent = '‚è≥ Generating...';

      fetch(`/generate-ai-reply/${ticketId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json',
        },
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          document.getElementById('{{ form.message.id_for_label }}').value = data.reply;
        } else {
          alert('Error generating AI response: ' + data.error);
        }
      })
      .catch(error => {
        alert('Error: ' + error);
      })
      .finally(() => {
        button.disabled = false;
        button.textContent = '‚ú® Generate AI Response';
      });
    });
  }
});
</script>
{% endblock %}
